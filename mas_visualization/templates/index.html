<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAS Visualization Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #eef2f9;
        }
        .dashboard-container { max-width: 1600px; }
        .card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border: none;
            border-radius: 0.75rem;
            transition: all 0.3s ease-in-out;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #343a40;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.25rem;
        }
        .agent-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
        }
        .agent-card .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #6c757d; /* Grey for idle */
            transition: background-color 0.3s ease;
        }
        .log-panel {
            background-color: #1e293b;
            color: #e2e8f0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            height: 350px;
            overflow-y: scroll;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .negotiation-visualizer {
            text-align: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #0d6efd;
            min-height: 50px;
        }
        .highlight-initiator { border: 2px solid #0d6efd !important; }
        .highlight-target { border: 2px solid #ffc107 !important; }
    </style>
</head>
<body>

    <div class="container-fluid p-4 dashboard-container">
        <h2 class="text-center mb-4"><i class="fas fa-project-diagram"></i> Multi-Agent System: Traffic Coordination</h2>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header"><i class="fas fa-cogs"></i> Simulation Controls</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="numClassrooms" class="form-label">Number of Classrooms</label>
                            <input type="number" class="form-control" id="numClassrooms" value="5" min="2">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="startBtn"><i class="fas fa-play"></i> Start Simulation</button>
                            <button class="btn btn-danger" id="stopBtn" disabled><i class="fas fa-stop"></i> Stop Simulation</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><i class="fas fa-traffic-light"></i> Bottleneck Status</div>
                    <div class="card-body">
                        <div class="mb-2"><strong>Capacity:</strong> <span id="bottleneckCapacity">--</span> students/min</div>
                        <div><strong>Congestion:</strong> <span id="bottleneckCongestion">0.0</span></div>
                        <div class="progress mt-2" role="progressbar" style="height: 20px;">
                            <div class="progress-bar bg-success" id="congestionBar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header"><i class="fas fa-users"></i> Agent Status</div>
                    <div class="card-body">
                        <div class="agent-grid" id="agentGrid"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><i class="fas fa-comments"></i> Live Log</div>
                    <div class="card-body">
                        <div class="negotiation-visualizer mb-3" id="negotiation-display">Waiting for negotiation...</div>
                        <div class="log-panel" id="logPanel">[System Ready]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const startBtn = document.getElementById("startBtn");
            const stopBtn = document.getElementById("stopBtn");
            // ... (rest of the JS variables)
            
            // --- WebSocket and UI Update Logic from previous step... ---
            // The JavaScript from the previous step will be pasted here,
            // but with a few key changes for the new functionality.
            // For simplicity, here is the complete, final script.
            
            // --- START: Complete Final JavaScript ---
            const logPanel = document.getElementById("logPanel");
            const agentGrid = document.getElementById("agentGrid");
            const bottleneckCapacityEl = document.getElementById("bottleneckCapacity");
            const bottleneckCongestionEl = document.getElementById("bottleneckCongestion");
            const congestionBar = document.getElementById("congestionBar");
            const negotiationDisplay = document.getElementById("negotiation-display");

            let ws;

            function connectWebSocket() {
                ws = new WebSocket("ws://localhost:8000/ws");
                ws.onopen = () => appendLogMessage("[System Connected]");
                ws.onclose = () => {
                    appendLogMessage("[System Disconnected]");
                    setButtons(true, false); // Enable start, disable stop
                };
                ws.onerror = () => appendLogMessage("[Connection Error]", 'error');
                ws.onmessage = handleWebSocketMessage;
            }

            function handleWebSocketMessage(event) {
                const update = JSON.parse(event.data);
                switch (update.type) {
                    case "log":
                        appendLogMessage(update.data);
                        if (update.data.includes("State saved successfully") || update.data.includes("Simulation Stopped")) {
                           setButtons(true, false); // Re-enable start
                        }
                        break;
                    case "agent_setup":
                        setupAgentGrid(update.data);
                        break;
                    case "bottleneck_update":
                        updateBottleneck(update.data);
                        break;
                    case "negotiation_start":
                        updateNegotiationDisplay(update.data.initiator, update.data.target);
                        break;
                    // Other cases can be added here for more detail
                    default:
                        // Default log for other message types
                        const dataStr = JSON.stringify(update.data);
                        appendLogMessage(`[${update.type}] ${dataStr.substring(0, 100)}...`);
                }
            }

            function appendLogMessage(message, level = 'info') {
                const logClass = level === 'error' ? 'text-danger' : '';
                logPanel.innerHTML += `<div class="${logClass}">${message}</div>`;
                logPanel.scrollTop = logPanel.scrollHeight;
            }

            function setupAgentGrid(agents) {
                agentGrid.innerHTML = '';
                agents.forEach(agent => {
                    const agentCard = document.createElement('div');
                    agentCard.className = 'card agent-card';
                    agentCard.id = agent.name;
                    agentCard.innerHTML = `
                        <div class="card-header">
                            <span><i class="fas fa-robot"></i> ${agent.name}</span>
                            <span class="status-light"></span>
                        </div>
                        <div class="card-body">
                            <p class="card-text mb-1"><small>Students: ${agent.students}</small></p>
                            <p class="card-text mb-1"><small>Flexibility: ${agent.flexibility}</small></p>
                        </div>
                    `;
                    agentGrid.appendChild(agentCard);
                });
            }

            function updateBottleneck(data) {
                bottleneckCapacityEl.innerText = data.capacity;
                const congestionPercent = (data.congestion * 100).toFixed(0);
                bottleneckCongestionEl.innerText = `${data.congestion} (${congestionPercent}%)`;
                
                congestionBar.style.width = `${congestionPercent}%`;
                congestionBar.innerText = `${congestionPercent}%`;
                congestionBar.className = "progress-bar"; // reset
                if (congestionPercent > 75) congestionBar.classList.add('bg-danger');
                else if (congestionPercent > 40) congestionBar.classList.add('bg-warning');
                else congestionBar.classList.add('bg-success');
            }

            function updateNegotiationDisplay(initiator, target) {
                document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('highlight-initiator', 'highlight-target'));
                negotiationDisplay.innerHTML = `<i class="fas fa-comments"></i> ${initiator} is negotiating with ${target}`;
                document.getElementById(initiator)?.classList.add('highlight-initiator');
                document.getElementById(target)?.classList.add('highlight-target');
            }
            
            function setButtons(startEnabled, stopEnabled) {
                startBtn.disabled = !startEnabled;
                stopBtn.disabled = !stopEnabled;
            }

            startBtn.addEventListener("click", function() {
                const numClassrooms = document.getElementById("numClassrooms").value;
                const formData = new FormData();
                formData.append("numClassrooms", numClassrooms);

                logPanel.innerHTML = "";
                agentGrid.innerHTML = "";
                appendLogMessage("[Starting Simulation...]");
                setButtons(false, true); // Disable start, enable stop
                
                if (!ws || ws.readyState === WebSocket.CLOSED) {
                    connectWebSocket();
                }

                fetch("/simulation/run", { method: "POST", body: formData });
            });
            
            stopBtn.addEventListener("click", function() {
                appendLogMessage("[Sending Stop Signal...]");
                setButtons(false, true); // Keep both disabled until confirmation
                fetch("/simulation/stop", { method: "POST" });
            });

            connectWebSocket(); // Initial connection
            // --- END: Complete Final JavaScript ---
        });
    </script>
</body>
</html>
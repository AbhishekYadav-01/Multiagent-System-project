<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAS Visualization Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- 1. CSS Variables for a Clean Light/Dark Theme --- */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg-color: #ffffff;
            --card-header-bg-color: #ffffff;
            --border-color: #dee2e6;
            --log-bg-color: #212529;
            --log-text-color: #f8f9fa;
            --highlight-initiator-border: #0d6efd;
            --highlight-target-border: #ffc107;
        }

        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg-color: #1e1e1e;
            --card-header-bg-color: #1e1e1e;
            --border-color: #444;
            --log-bg-color: #000000;
            --log-text-color: #e0e0e0;
        }

        /* --- 2. General Body and Typography --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- 3. Clean Card Style (No Glass Effect) --- */
        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-radius: 0.5rem;
            transition: all 0.3s ease-in-out;
            color: var(--text-color);
        }
        .card-header {
            background-color: var(--card-header-bg-color);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-color);
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        
        /* --- UI Polish and Layout --- */
        .dashboard-container { max-width: 1600px; }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .theme-switcher { display: flex; align-items: center; gap: 0.5rem; }
        .theme-switcher .form-check-input { width: 3em; height: 1.5em; }
        
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.25rem;
        }
        
        .log-panel {
            background-color: var(--log-bg-color);
            color: var(--log-text-color);
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            height: 350px;
            overflow-y: scroll;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .negotiation-visualizer {
            text-align: center;
            padding: 1rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-weight: 600;
            color: var(--highlight-initiator-border);
            min-height: 50px;
        }

        .highlight-initiator { border: 2px solid var(--highlight-initiator-border) !important; }
        .highlight-target { border: 2px solid var(--highlight-target-border) !important; }
    </style>
</head>
<body>

    <div class="container-fluid p-4 dashboard-container">
        <div class="dashboard-header">
            <h2 class="mb-0"><i class="fas fa-project-diagram"></i> Multi-Agent System</h2>
            <div class="theme-switcher">
                <i class="fas fa-sun"></i>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch">
                </div>
                <i class="fas fa-moon"></i>
            </div>
        </div>
        
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header"><i class="fas fa-cogs"></i> Simulation Controls</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="numClassrooms" class="form-label">Number of Classrooms</label>
                            <input type="number" class="form-control" id="numClassrooms" value="5" min="2">
                        </div>
                        <div class="mb-3">
                            <label for="numEpisodes" class="form-label">Number of Episodes</label>
                            <input type="number" class="form-control" id="numEpisodes" value="1" min="1">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="startBtn"><i class="fas fa-play"></i> Run Simulation(s)</button>
                            <button class="btn btn-danger" id="stopBtn" disabled><i class="fas fa-stop"></i> Stop Simulation</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><i class="fas fa-traffic-light"></i> Bottleneck Status</div>
                    <div class="card-body">
                        <div class="mb-2"><strong>Capacity:</strong> <span id="bottleneckCapacity">--</span> students/min</div>
                        <div><strong>Congestion:</strong> <span id="bottleneckCongestion">0.0</span></div>
                        <div class="progress mt-2" role="progressbar" style="height: 20px;">
                            <div class="progress-bar" id="congestionBar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header"><i class="fas fa-users"></i> Agent Status</div>
                    <div class="card-body">
                        <div class="agent-grid" id="agentGrid"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><i class="fas fa-comments"></i> Live Log</div>
                    <div class="card-body">
                        <div class="negotiation-visualizer mb-3" id="negotiation-display">Waiting for negotiation...</div>
                        <div class="log-panel" id="logPanel">[System Ready]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // The JavaScript code remains exactly the same as the previous version.
        // It will work perfectly with the new styles.
        document.addEventListener("DOMContentLoaded", function() {
            // Theme Switcher Logic
            const themeSwitch = document.getElementById('themeSwitch');
            const currentTheme = localStorage.getItem('theme');

            if (currentTheme) {
                document.body.classList.add(currentTheme);
                if (currentTheme === 'dark-mode') {
                    themeSwitch.checked = true;
                }
            }

            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light-mode');
                }
            });

            // Simulation Logic
            const startBtn = document.getElementById("startBtn");
            const stopBtn = document.getElementById("stopBtn");
            const logPanel = document.getElementById("logPanel");
            const agentGrid = document.getElementById("agentGrid");
            const bottleneckCapacityEl = document.getElementById("bottleneckCapacity");
            const bottleneckCongestionEl = document.getElementById("bottleneckCongestion");
            const congestionBar = document.getElementById("congestionBar");
            const negotiationDisplay = document.getElementById("negotiation-display");
            
            let ws;

            function connectWebSocket() {
                ws = new WebSocket("ws://localhost:8000/ws");
                ws.onopen = () => appendLogMessage("[System Connected]");
                ws.onclose = () => { appendLogMessage("[System Disconnected]"); setButtons(true, false); };
                ws.onerror = () => appendLogMessage("[Connection Error]", 'error');
                ws.onmessage = handleWebSocketMessage;
            }

            function handleWebSocketMessage(event) {
                const update = JSON.parse(event.data);
                switch (update.type) {
                    case "log":
                        appendLogMessage(update.data);
                        if (update.data.includes("Final state saved successfully") || update.data.includes("Simulation Stopped")) {
                           setButtons(true, false);
                           document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('highlight-initiator', 'highlight-target'));
                           negotiationDisplay.innerHTML = "Simulation Finished";
                        }
                        break;
                    case "agent_setup":
                        setupAgentGrid(update.data);
                        break;
                    case "bottleneck_update":
                        updateBottleneck(update.data);
                        break;
                    case "negotiation_start":
                        updateNegotiationDisplay(update.data.initiator, update.data.target);
                        break;
                    default:
                        const dataStr = JSON.stringify(update.data);
                        appendLogMessage(`[${update.type}] ${dataStr.substring(0, 150)}...`);
                }
            }

            function appendLogMessage(message, level = 'info') {
                const logClass = level === 'error' ? 'text-danger' : '';
                logPanel.innerHTML += `<div class="${logClass}">${message}</div>`;
                logPanel.scrollTop = logPanel.scrollHeight;
            }

            function setupAgentGrid(agents) {
                agentGrid.innerHTML = '';
                agents.forEach(agent => {
                    const agentCard = document.createElement('div');
                    agentCard.className = 'card agent-card';
                    agentCard.id = agent.name;
                    agentCard.innerHTML = `
                        <div class="card-header">
                            <span><i class="fas fa-robot"></i> ${agent.name}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text mb-1"><small>Students: ${agent.students}</small></p>
                            <p class="card-text mb-1"><small>Flexibility: ${agent.flexibility}</small></p>
                        </div>`;
                    agentGrid.appendChild(agentCard);
                });
            }

            function updateBottleneck(data) {
                bottleneckCapacityEl.innerText = data.capacity;
                const congestionPercent = (data.congestion * 100).toFixed(0);
                bottleneckCongestionEl.innerText = `${data.congestion} (${congestionPercent}%)`;
                
                congestionBar.style.width = `${congestionPercent}%`;
                congestionBar.innerText = `${congestionPercent}%`;
                congestionBar.className = "progress-bar";
                if (congestionPercent > 75) congestionBar.classList.add('bg-danger');
                else if (congestionPercent > 40) congestionBar.classList.add('bg-warning');
                else congestionBar.classList.add('bg-success');
            }

            function updateNegotiationDisplay(initiator, target) {
                document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('highlight-initiator', 'highlight-target'));
                negotiationDisplay.innerHTML = `<i class="fas fa-comments"></i> ${initiator} is negotiating with ${target}`;
                document.getElementById(initiator)?.classList.add('highlight-initiator');
                document.getElementById(target)?.classList.add('highlight-target');
            }
            
            function setButtons(startEnabled, stopEnabled) {
                startBtn.disabled = !startEnabled;
                stopBtn.disabled = !stopEnabled;
            }

            startBtn.addEventListener("click", function() {
                const numClassrooms = document.getElementById("numClassrooms").value;
                const numEpisodes = document.getElementById("numEpisodes").value;
                const formData = new FormData();
                formData.append("numClassrooms", numClassrooms);
                formData.append("numEpisodes", numEpisodes);

                logPanel.innerHTML = "";
                agentGrid.innerHTML = "";
                negotiationDisplay.innerHTML = "Waiting for negotiation...";
                appendLogMessage("[Starting Simulation...]");
                setButtons(false, true);
                
                if (!ws || ws.readyState === WebSocket.CLOSED) { connectWebSocket(); }
                fetch("/simulation/run", { method: "POST", body: formData });
            });
            
            stopBtn.addEventListener("click", function() {
                appendLogMessage("[Sending Stop Signal...]");
                setButtons(false, true);
                fetch("/simulation/stop", { method: "POST" });
            });

            connectWebSocket();
        });
    </script>
</body>
</html>